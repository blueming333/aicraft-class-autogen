## 课程 4：Suna 通用智能体 & Sandbox（精简版）

目标：用最短时间理解——通用智能体要做什么、Sandbox 为什么必须、各自怎么落地。

### 1. 通用智能体是什么
一句话：可感知输入、拆解任务、调用工具、总结记忆的“可编排执行体”。
核心循环：感知 → 规划 → 行动 → 复盘。

### 2. 关键模块（最小集合）
- 编排：管理步骤与状态。
- 规划：把意图拆成可执行步骤。
- 工具层：统一封装 API / DB / 脚本。
- 记忆：当前对话短记 + 历史长记。
- 策略与守卫：权限 / 额度 / 审计。
- 反馈：结果评估 + 必要重试。

### 3. 为什么要 Sandbox
目的：让“可能不安全/不确定”的执行被隔离、被限制、可回放。
三词总结：隔离 + 控制 + 追溯。
没有它的风险：越权访问、破坏数据、泄露、不可审计。

### 4. Sandbox 核心做法
- 资源限额：CPU / 内存 / 超时。
- 文件隔离：只读挂载 + 临时目录。
- 网络白名单：默认拒绝，按需开放。
- 安全扫描：AST / 关键字过滤危险调用。
- 执行日志：全量 stdout/stderr + TraceID。
- 一次性环境：执行完销毁。

### 5. 典型执行流程（9 步压缩版）
请求 → 分配隔离 → 校验策略 → 静态扫描 → 运行 → 采集输出 → 异常/超时处理 → 记录审计 → 清理。

### 6. 常见使用场景（只记触发条件）
- 爬取 / 抓取：外网访问 + 代码动态生成。
- 数据清洗：用户上传文件 + 代码加工。
- 代码生成测试：LLM 产出脚本需安全跑。
- 文档转换：涉及依赖库与临时文件。
- 规则回测：读取历史快照、不可写生产。
- 多工具实验：组合调用避免污染主环境。

### 7. 集成外部系统最小策略
- DB：只允许已模板化查询；禁 DDL。
- 微服务：统一网关 + Token 透传。
- 第三方 API：Key 管理 + 频控。
- 文件：输入只读，输出显式白名单。
- 消息队列：事件触发 + 幂等重试。

### 8. 监控记四项
指标(成功率/时长/重试) + 日志(结构化) + Trace(跨步骤) + 回放(输入输出快照)。

### 9. 隔离级别快速选择
高风险（外网 / 动态写 / 敏感数据）→ 强隔离(容器/轻量 VM)。
中低风险（读只读数据 / 纯计算）→ 轻量解释器隔离。

### 10. 落地最佳 5 条（精简）
1. 先分风险等级，再定执行路径。
2. 所有外部访问统一 Adapter 留审计。
3. 设硬性退出条件防无限循环。
4. 高价值结果二次校验（模型或规则）。
5. 版本 + Trace 绑定，保证可复现。

### 11. 快速练习
Q1：挑一个任务，圈出需 Sandbox 的步骤。
Q2：写 3 条 AST 过滤规则（禁危险库/系统调用）。
Q3：为“数据清洗”分配风险级与隔离级别。

### 12. 速记
循环：感知-规划-行动-复盘。
Sandbox 3 目的：隔离 / 控制 / 追溯。
高风险触发：外网 + 动态代码 + 写操作。
可观测 4 件套：指标 / 日志 / Trace / 回放。

总结：通用智能体解决“如何持续把意图变成安全可控执行”，Sandbox 让“有风险的那部分”被装进盒子再运行。

（完）
